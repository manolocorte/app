{% extends 'base.html' %}

{% block app_content %}
    <style>
        #text {
            width: 100%;
            text-align: center;
        }
        #file_state {
            width: 100%;
            text-align: center;
            font-weight: bold;
        } 
    </style>
    <h1>Check Task Status</h1>
    <h2>Synthetic Tasks</h2>
    <div id="progress_2"></div>
    <script src="//cdnjs.cloudflare.com/ajax/libs/nanobar/0.2.1/nanobar.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script>
        var tasks = '{{ tasks }}';
        var file_type = '{{ file_type }}'
        var list_tasks = tasks.replace('[', '').replace(']', '').split(',');
        var nanobars = [];
        var divs = [];
        for (let i = 0; i < list_tasks.length; i++) {
            // add task status elements
            div = $('<div class="progress_bars"><div id="file_state"></div><div id="text"></div><div id="text"></div><div>&nbsp;</div><div class="progress"><div id="dynamic_%s" class="progress-bar progress-bar-success progress-bar-striped active" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"><span id="current-progress"></span></div></div>'.replace('%s', i))
            divs[i] = div;
            $('#progress_2').prepend(divs[i]); 
        }

        if ( file_type == 'person' || file_type == 'phr' || file_type== 'trial'){
            for (i = 0; i < divs.length; i++) {
                (function(x){
                    $.ajax({
                        type: 'POST',
                        url: `/pass_task_${file_type}/${i}`,
                        success: function(data, status, request) {
                            status_url = request.getResponseHeader('Location');
                            update_progress(status_url, divs[x][0], x);

                        },
                        error: function() {
                            alert('Unexpected error');
                        }
                    });
                })(i)
            }
        }

        function update_progress(status_url, status_div, number_task) {
            // send GET request to status URL
            $.getJSON(status_url, function(data) {
                // update UI
                percent = parseInt(data['current'] * 100 / data['total']);
                $("#dynamic_%s".replace('%s', number_task))
                .css("width", percent + "%")
                .css("background-color", "rgb(64, %g, %b)".replace('%g', 156).replace('%b', 200-percent*2))
                .attr("aria-valuenow", percent)
                .text(percent + "% Complete")
                if (percent==100) {
                    $("#dynamic_%s".replace('%s', number_task))
                    .attr("class", "progress-bar")
                    .css("background-color", "rgb(64, 156, 0)")
                    // .removeClass('active');
                }
                $(status_div.childNodes[0]).text(data['status']);
                // var parameters = 'Parameters: Countries = ' + data['parameters']['Countries'] + 'Min Age = ' + data['parameters']['Age range'][0]
                //     + 'Max Age = ' + data['parameters']['Age range'][1] + '% Female = ' + data['parameters']['Gender distribution'][0]
                //     + '% Male = ' + data['parameters']['Gender distribution'][1] + 'Drug Regulator = ' + data['parameters']['Drug regulator']
                //     + 'Device Regulator = ' + data['parameters']['Device regulator'] + 'Output Type = ' + data['parameters']['Output type']
                $(status_div.childNodes[1]).text(data['parameters']);
                // $(status_div.childNodes[2]).text('cde');
                if (data['state'] != 'PENDING' && data['state'] != 'PROGRESS') {
                    if ('result' in data) {
                        // show result
                        $(status_div.childNodes[2]).text('Result: ' + data['result']);
                    }
                    else {
                        // something unexpected happened
                        $(status_div.childNodes[2]).text('Result: ' + data['state']);
                        $("#dynamic_%s".replace('%s', number_task))
                        .attr("class", "progress-bar")
                        .css("background-color", "rgb(255, 0, 0)")
                    }
                }
                else {
                    // rerun in 2 seconds
                    setTimeout(function() {
                        update_progress(status_url, status_div, number_task);
                    }, 10);
                }
            });
        }
    </script>
{% endblock %}